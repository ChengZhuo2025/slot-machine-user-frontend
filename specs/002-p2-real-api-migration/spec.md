# Feature Specification: P2阶段API真实接口迁移

**Feature Branch**: `002-p2-real-api-migration`
**Created**: 2026-01-17
**Status**: Draft
**Input**: User description: "推进P2阶段开发，从mock数据迁移到后端真实api接口"

## Clarifications

### Session 2026-01-17

- Q: 数据缓存策略如何定义？ → A: 使用短期内存缓存（5-10分钟），首次加载后展示缓存，后台静默刷新
- Q: 用户快速切换分类或筛选条件时，如何处理请求竞态条件？ → A: 在发起新请求时自动取消之前未完成的同类请求，只保留最新的请求
- Q: 图片加载优化策略是什么？ → A: 懒加载+渐进式加载：先加载缩略图占位，可见时加载高清图
- Q: 搜索输入防抖策略是什么？ → A: 使用防抖机制，用户停止输入300-500ms后发送请求
- Q: 后端服务不可用时的降级策略是什么？ → A: 优先展示本地缓存数据，同时显示"数据可能不是最新"的提示和刷新按钮

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 首页数据实时展示 (Priority: P1)

用户打开应用首页时，能够看到从后端获取的实时数据，包括轮播广告、推荐酒店、热门房型、附近酒店、限时优惠和精选商品，而不是固定的模拟数据。

**Why this priority**: 首页是用户进入应用的第一个界面，展示实时数据直接影响用户体验和业务转化。

**Independent Test**: 可以通过刷新首页验证数据是否从后端实时加载，数据应该能够反映后台的最新变更。

**Acceptance Scenarios**:

1. **Given** 用户已登录应用, **When** 打开首页, **Then** 看到从后端加载的轮播广告图片和链接
2. **Given** 用户在首页, **When** 查看推荐酒店区域, **Then** 看到根据位置或推荐算法返回的酒店信息
3. **Given** 用户在首页, **When** 查看热门房型, **Then** 看到按热度排序的真实房型数据
4. **Given** 后台更新了首页Banner, **When** 用户刷新首页, **Then** 能看到更新后的Banner内容

---

### User Story 2 - 商城商品动态加载 (Priority: P1)

用户浏览商城时，能够看到从后端获取的商品分类和商品列表，支持分类切换、排序和分页加载。

**Why this priority**: 商城是核心业务模块之一，商品数据的真实性直接影响交易转化。

**Independent Test**: 可以通过在后台添加新商品后，在前端刷新商城页面验证新商品是否出现。

**Acceptance Scenarios**:

1. **Given** 用户进入商城页面, **When** 页面加载完成, **Then** 看到从后端获取的商品分类导航
2. **Given** 用户在商城页面, **When** 切换商品分类, **Then** 看到对应分类下的商品列表
3. **Given** 用户在商城页面, **When** 选择排序方式（新品/热销/价格）, **Then** 商品按照所选规则重新排序
4. **Given** 用户在商城页面, **When** 滚动到底部, **Then** 自动加载更多商品（分页）

---

### User Story 3 - 酒店列表真实数据 (Priority: P1)

用户浏览酒店列表时，能够看到从后端获取的酒店信息，支持位置筛选、分类筛选和搜索功能。

**Why this priority**: 酒店预订是核心业务，酒店数据的准确性直接影响用户预订决策。

**Independent Test**: 可以通过在后台上架新酒店后，在前端刷新酒店列表验证新酒店是否出现。

**Acceptance Scenarios**:

1. **Given** 用户进入酒店列表页, **When** 页面加载完成, **Then** 看到从后端获取的酒店列表数据
2. **Given** 用户开启位置权限, **When** 查看附近酒店, **Then** 看到按距离排序的酒店列表
3. **Given** 用户在酒店列表页, **When** 使用搜索功能, **Then** 看到匹配搜索关键词的酒店结果
4. **Given** 用户在酒店列表页, **When** 切换酒店分类标签, **Then** 看到对应分类的酒店

---

### User Story 4 - 房型信息实时获取 (Priority: P2)

用户查看酒店房型时，能够看到从后端获取的房型信息，包括房型详情、价格、可用时间等。

**Why this priority**: 房型是预订的核心信息，但依赖于酒店列表功能完成后才能使用。

**Independent Test**: 可以通过在后台修改房型价格后，在前端刷新房型详情验证价格是否更新。

**Acceptance Scenarios**:

1. **Given** 用户进入酒店详情页, **When** 查看房型列表, **Then** 看到该酒店的真实房型数据
2. **Given** 用户查看房型, **When** 点击查看详情, **Then** 看到房型的完整信息（图片、设施、价格等）
3. **Given** 用户查看热门房型, **When** 点击房型卡片, **Then** 跳转到对应房型详情页

---

### User Story 5 - 优惠券和活动数据 (Priority: P2)

用户能够看到从后端获取的优惠券和促销活动信息，支持领取优惠券操作。

**Why this priority**: 优惠活动影响用户购买决策，但不是核心交易流程的必须组件。

**Independent Test**: 可以通过在后台创建新优惠券后，在前端验证用户是否能看到并领取该优惠券。

**Acceptance Scenarios**:

1. **Given** 用户在首页, **When** 查看限时优惠区域, **Then** 看到从后端获取的优惠券列表
2. **Given** 用户看到可领取的优惠券, **When** 点击领取按钮, **Then** 优惠券成功添加到用户账户
3. **Given** 用户已领取过优惠券, **When** 再次查看该优惠券, **Then** 显示"已领取"状态

---

### User Story 6 - 数据加载状态管理 (Priority: P3)

在数据加载过程中，用户能够看到合适的加载状态提示，在加载失败时能够看到友好的错误提示和重试选项。

**Why this priority**: 良好的加载状态提升用户体验，但不影响核心功能。

**Independent Test**: 可以通过模拟网络延迟或断开网络验证加载状态和错误处理是否正常工作。

**Acceptance Scenarios**:

1. **Given** 用户请求数据, **When** 数据正在加载中, **Then** 看到加载中的状态指示器（骨架屏或加载动画）
2. **Given** 数据加载失败, **When** 用户看到错误提示, **Then** 可以点击重试按钮重新加载
3. **Given** 网络恢复正常, **When** 用户点击重试, **Then** 数据成功加载并展示

---

### Edge Cases

- 后端服务不可用时，前端优先展示本地缓存数据（如有），同时显示"数据可能不是最新"的提示和刷新按钮；如无缓存则显示错误提示和重试按钮
- 用户位置权限被拒绝时，附近酒店功能应降级为显示热门酒店或城市酒店
- 商品或酒店数据为空时，应显示空状态引导页面
- 用户快速切换分类或筛选条件时，系统自动取消之前未完成的同类请求，只保留最新请求的结果
- Token过期时应自动刷新或引导用户重新登录（P1已实现）

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须从后端API获取首页轮播广告数据并展示
- **FR-002**: 系统必须从后端API获取推荐酒店列表并在首页展示
- **FR-003**: 系统必须从后端API获取热门房型数据并在首页展示
- **FR-004**: 系统必须从后端API获取附近酒店列表，支持基于用户位置的筛选
- **FR-005**: 系统必须从后端API获取精选商品数据并在首页展示
- **FR-006**: 系统必须从后端API获取商品分类列表并在商城页展示
- **FR-007**: 系统必须从后端API获取商品列表，支持分类、排序和分页
- **FR-008**: 系统必须从后端API获取酒店列表，支持筛选、排序和搜索
- **FR-009**: 系统必须从后端API获取酒店房型列表
- **FR-010**: 系统必须从后端API获取优惠券列表和优惠活动信息
- **FR-011**: 系统必须支持用户领取优惠券操作
- **FR-012**: 系统必须在数据加载中显示加载状态
- **FR-013**: 系统必须在数据加载失败时显示错误提示和重试选项
- **FR-014**: 系统必须支持下拉刷新功能以重新获取最新数据
- **FR-015**: 系统必须支持上拉加载更多（分页）功能
- **FR-016**: 系统必须实现短期内存缓存机制（5-10分钟有效期），首次加载后优先展示缓存数据，同时在后台静默刷新
- **FR-017**: 系统必须实现请求取消机制，当用户快速切换分类或筛选条件时，自动取消之前未完成的同类请求
- **FR-018**: 系统必须实现图片懒加载和渐进式加载，先加载缩略图占位，图片进入可视区域时加载高清图
- **FR-019**: 系统必须对搜索输入实现防抖机制，在用户停止输入300-500毫秒后发送搜索请求
- **FR-020**: 系统必须实现降级策略，当后端服务不可用时优先展示本地缓存数据，并显示数据状态提示和刷新选项

### Key Entities

- **Banner（轮播广告）**: 广告ID、图片URL、跳转链接、排序权重、展示状态
- **酒店**: 酒店ID、名称、地址、星级、封面图、距离、价格范围、可用房间数
- **房型**: 房型ID、酒店ID、房型名称、图片、价格（时租/日租）、预订数、评分
- **商品分类**: 分类ID、分类名称、图标、排序
- **商品**: 商品ID、名称、图片、原价、会员价、分类、销量、库存、规格
- **优惠券**: 优惠券ID、名称、面额、使用条件、有效期、领取状态

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 首页数据加载完成后，用户能在2秒内看到完整的页面内容
- **SC-002**: 商品列表分页加载时，用户能在1秒内看到新加载的商品
- **SC-003**: 数据加载失败时，100%的情况下显示错误提示和重试按钮
- **SC-004**: 下拉刷新操作后，用户能在3秒内看到最新数据
- **SC-005**: 所有mock数据完成迁移后，页面功能与迁移前保持一致
- **SC-006**: API请求错误率低于1%时，用户操作流程不受影响

## Assumptions

- 后端API已经就绪并符合前端预期的数据格式
- 后端API遵循RESTful设计规范，返回格式与P1阶段保持一致（code=0或code=200表示成功）
- 现有的request.js封装的请求拦截器、响应处理和Token刷新机制可以复用
- 图片资源由后端返回完整URL或使用统一的图片CDN域名
- 分页API采用page/page_size参数格式
